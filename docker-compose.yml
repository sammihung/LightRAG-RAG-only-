services:
  lightrag:
    container_name: lightrag
    image: ghcr.io/hkuds/lightrag:latest
    build:
      context: .
      dockerfile: Dockerfile
      tags:
        - ghcr.io/hkuds/lightrag:latest
    ports:
      - "${PORT:-9621}:9621"
      
    # ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€æ–°å¢ã€‘å•Ÿç”¨å½çµ‚ç«¯æ©Ÿ (è®“ä¸‹è¼‰é€²åº¦æ¢é¡¯ç¤ºå‡ºä¾†) ğŸ‘‡ğŸ‘‡ğŸ‘‡
    tty: true
    stdin_open: true

    volumes:
      # ---------------------------------------------------------
      # ğŸ’¾ [è³‡æ–™æŒä¹…åŒ– Data Persistence]
      # ---------------------------------------------------------
      # ç›´æ¥æ›è¼‰æ•´å€‹ data ç›®éŒ„ï¼Œé€™æœƒåŒæ™‚åŒ…å«:
      # 1. /app/data/rag_storage (å‘é‡åº«)
      # 2. /app/data/inputs (è¼¸å…¥æ–‡ä»¶)
      # 3. /app/data/mineru_models (è‡ªå‹•ä¸‹è¼‰çš„æ¨¡å‹åº«)
      - ./data:/app/data
      
      # è¨­å®šæª”
      - ./config.ini:/app/config.ini
      - ./.env:/app/.env

    env_file:
      - .env

    environment:
      # ---------------------------------------------------------
      # âš™ï¸ [LightRAG æ ¸å¿ƒè¨­å®š]
      # ---------------------------------------------------------
      - WORKERS=1
      - TIMEOUT=1800
      # å»¶é•·è¶…æ™‚è‡³ 30 åˆ†é˜ (1800ç§’)ï¼Œçµ¦ MinerU è¶³å¤ æ™‚é–“ä¸‹è¼‰æ¨¡å‹å’Œè§£æ PDF
      - LIGHTRAG_WORKER_TIMEOUT=1800
      - LIGHTRAG_FUNC_TIMEOUT=1800

      # ---------------------------------------------------------
      # ğŸ§  [MinerU (Magic-PDF) è¨­å®š]
      # ---------------------------------------------------------
      # é‹è¡Œæ¨¡å¼: 'cpu' æˆ– 'cuda'
      # é è¨­ 'cpu'ã€‚å¦‚æœæœ‰ Nvidia é¡¯å¡ï¼Œè«‹æ”¹ç‚º 'cuda' ä¸¦å•Ÿç”¨ä¸‹æ–¹çš„ deployã€‚
      - MINERU_DEVICE_MODE=cpu
      
      # æ¨¡å‹å­˜æ”¾ä½ç½®
      - MINERU_MODEL_DIR=/app/data/mineru_models

      # ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€é—œéµæ–°å¢ã€‘å¼·åˆ¶æŒ‡å®š Config è·¯å¾‘ (é˜²æ­¢æ‰¾ä¸åˆ°è¨­å®šæª”) ğŸ‘‡ğŸ‘‡ğŸ‘‡
      # é…åˆ entrypoint.sh çš„è¤‡è£½é‚è¼¯ï¼Œç¢ºä¿ MinerU ä¸€å®šè®€å¾—åˆ°
      - MAGIC_PDF_CONFIG_JSON=/app/magic-pdf.json
      # é›™é‡ä¿éšª (èˆŠç‰ˆç›¸å®¹)
      - MAGIC_PDF_CONFIG=/app/magic-pdf.json

    # ---------------------------------------------------------
    # ğŸ® [GPU åŠ é€Ÿæ”¯æ´] (å¦‚éœ€å•Ÿç”¨ CUDAï¼Œè«‹å–æ¶ˆä»¥ä¸‹è¨»è§£)
    # ---------------------------------------------------------
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"