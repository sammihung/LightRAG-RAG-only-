services:
  lightrag:
    container_name: lightrag-rag
    image: ghcr.io/hkuds/lightrag:latest
    build:
      context: .
      dockerfile: Dockerfile
      tags:
        - ghcr.io/hkuds/lightrag:latest
    ports:
      - "${PORT:-9621}:9621"
      
    # ğŸ‘‡ ä¿æŒé–‹å•Ÿï¼Œé€™å°çœ‹ Log å¾ˆæœ‰å¹«åŠ©
    tty: true
    stdin_open: true

    volumes:
      # ---------------------------------------------------------
      # ğŸ’¾ [è³‡æ–™æŒä¹…åŒ–] (å»ºè­°æ”¹ç”¨åˆ†é–‹æ›è¼‰ï¼Œé¿å…è¦†è“‹æ‰ Image è£¡çš„æª”æ¡ˆ)
      # ---------------------------------------------------------
      # âš ï¸ æ³¨æ„ï¼šä¸è¦æ›è¼‰æ•´å€‹ /app/dataï¼Œå› ç‚º Docker Image è£¡å·²ç¶“é è¼‰äº† tiktoken
      # å¦‚æœæ›è¼‰æ•´å€‹ç›®éŒ„ï¼Œæœ¬åœ°ç©ºçš„ ./data æœƒè¦†è“‹æ‰å®¹å™¨å…§çš„æª”æ¡ˆã€‚
      - ./data/rag_storage:/app/data/rag_storage
      - ./data/inputs:/app/data/inputs
      - ./data/mineru_models:/app/data/mineru_models
      
      # è¨­å®šæª”
      - ./config.ini:/app/config.ini
      - ./.env:/app/.env

    env_file:
      - .env

    environment:
      # ---------------------------------------------------------
      # âš™ï¸ [LightRAG æ ¸å¿ƒè¨­å®š]
      # ---------------------------------------------------------
      - WORKERS=1
      - TIMEOUT=1800
      - LIGHTRAG_WORKER_TIMEOUT=1800
      - LIGHTRAG_FUNC_TIMEOUT=1800

      # ---------------------------------------------------------
      # ğŸ§  [MinerU (Magic-PDF) è¨­å®š]
      # ---------------------------------------------------------
      # ğŸ”¥ [é—œéµä¿®æ”¹ 1] æ”¹ç‚º cuda ä»¥å•Ÿç”¨é¡¯å¡åŠ é€Ÿ
      - MINERU_DEVICE_MODE=cuda
      
      # æ¨¡å‹å­˜æ”¾ä½ç½®
      - MINERU_MODEL_DIR=/app/data/mineru_models

      # è¨­å®šæª”è·¯å¾‘
      - MAGIC_PDF_CONFIG_JSON=/app/magic-pdf.json
      - MAGIC_PDF_CONFIG=/app/magic-pdf.json

    # ---------------------------------------------------------
    # ğŸ® [GPU åŠ é€Ÿæ”¯æ´] (ğŸ”¥ [é—œéµä¿®æ”¹ 2] è§£é™¤è¨»è§£ä¸¦å•Ÿç”¨)
    # ---------------------------------------------------------
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1          # å¦‚æœæœ‰å¤šå¼µå¡æƒ³å…¨ç”¨ï¼Œæ”¹ç‚º 'all'
              capabilities: [gpu]

    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"